name: Article Review Workflow

on:
  issues:
    types: [opened, labeled]

jobs:
  process-article-review:
    if: contains(github.event.issue.labels.*.name, 'article-review')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract article metadata
        id: extract-metadata
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Parse issue body to extract article information
            const urlMatch = body.match(/### Article URL\s*\n\s*(.+)/);
            const titleMatch = body.match(/### Article Title\s*\n\s*(.+)/);
            const authorMatch = body.match(/### Author\(s\)\s*\n\s*(.+)/);
            const relevanceMatch = body.match(/### Relevance to A2I Curriculum\s*\n\s*([\s\S]*?)\n\s*###/);
            
            const metadata = {
              url: urlMatch ? urlMatch[1].trim() : 'Not provided',
              title: titleMatch ? titleMatch[1].trim() : 'Not provided',
              author: authorMatch ? authorMatch[1].trim() : 'Not provided',
              relevance: relevanceMatch ? relevanceMatch[1].trim() : 'Not provided'
            };
            
            core.setOutput('url', metadata.url);
            core.setOutput('title', metadata.title);
            core.setOutput('author', metadata.author);
            
            return metadata;

      - name: Auto-label by curriculum area
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body ? issue.body.toLowerCase() : '';
            const labels = [];
            
            // Add labels based on curriculum areas mentioned
            const areaMapping = {
              'machine learning': 'curriculum-ml',
              'deep learning': 'curriculum-dl',
              'nlp': 'curriculum-nlp',
              'computer vision': 'curriculum-cv',
              'ethics': 'governance',
              'entrepreneurship': 'entrepreneurship',
              'industry': 'industry-trends',
              'career': 'career-development'
            };
            
            for (const [keyword, label] of Object.entries(areaMapping)) {
              if (body.includes(keyword)) {
                labels.push(label);
              }
            }
            
            // Check urgency
            if (body.includes('high - significant') || body.includes('critical - immediate')) {
              labels.push('priority:high');
            }
            
            // Add general curriculum label
            labels.push('curriculum');
            
            // Add labels to issue
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [...new Set(labels)]
              });
            }

      - name: Add initial review comment
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            
            const comment = `## ðŸ“š Article Review Initiated
            
            Thank you for submitting this article for curriculum review! 
            
            **Next Steps:**
            1. âœ… Your submission has been received and labeled
            2. ðŸ” Curriculum team will review the article's relevance and impact
            3. ðŸ“ A detailed analysis will be added to \`docs/research/\` if applicable
            4. ðŸ’¡ Integration recommendations will be provided
            
            **Review Process:**
            - Initial triage: 2-3 business days
            - Full review: 1-2 weeks (depending on urgency)
            - Implementation timeline: Varies based on impact assessment
            
            **Resources:**
            - [Article Review Template](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/research/article-review-template.md)
            - [Research Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/docs/research)
            - [Contributing Guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
            
            ---
            
            *This is an automated response. A human reviewer will follow up soon.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: comment
            });

      - name: Assign to curriculum team
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            
            // Add to curriculum project board (if it exists)
            // This is a placeholder for project board integration
            console.log('Would assign to curriculum team project board');
            
            // Create a checklist for reviewers
            const reviewChecklist = `## ðŸ‘¥ Reviewer Checklist
            
            **For Curriculum Team:**
            
            - [ ] Read and summarize the article
            - [ ] Assess relevance to curriculum goals
            - [ ] Identify specific courses/modules impacted
            - [ ] Determine integration approach (if applicable)
            - [ ] Consider resource requirements
            - [ ] Draft integration recommendations
            - [ ] Create article review document (if warranted)
            - [ ] Provide feedback to submitter
            
            **Decision:**
            - [ ] Integrate into curriculum
            - [ ] Add to recommended reading
            - [ ] Track for future consideration
            - [ ] No action needed (explain why)
            
            ---
            
            **Assigned Reviewers:** Please assign appropriate reviewers
            
            *Please complete this checklist as you review the article.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: reviewChecklist
            });

      - name: Check for similar articles
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            
            // Search for similar article reviews
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'article-review',
              state: 'all',
              per_page: 100
            });
            
            // Simple similarity check based on keywords
            const currentWords = title.split(/\s+/).filter(w => w.length > 3);
            const similarIssues = issues.filter(i => {
              if (i.number === issue.number) return false;
              const otherTitle = i.title.toLowerCase();
              return currentWords.some(word => otherTitle.includes(word));
            });
            
            if (similarIssues.length > 0) {
              const links = similarIssues.slice(0, 5).map(i => 
                `- #${i.number}: ${i.title}`
              ).join('\n');
              
              const comment = `## ðŸ”— Related Article Reviews
              
              We found similar article reviews that might be relevant:
              
              ${links}
              
              Please check these to avoid duplication and build on previous work.`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
            }

  notify-on-completion:
    if: |
      contains(github.event.issue.labels.*.name, 'article-review') &&
      (contains(github.event.issue.labels.*.name, 'reviewed') ||
       contains(github.event.issue.labels.*.name, 'integrated'))
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Thank submitter on completion
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const isIntegrated = issue.labels.some(l => l.name === 'integrated');
            
            const message = isIntegrated
              ? `## âœ¨ Article Successfully Integrated!
              
              Thank you for your contribution! This article has been reviewed and integrated into the curriculum.
              
              **Impact:** Your submission is helping shape the future of AI education.
              
              Check the issue comments for details on how the article was incorporated.`
              : `## âœ… Article Review Complete
              
              Thank you for your submission! The curriculum team has completed their review of this article.
              
              See the comments above for the review findings and recommendations.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: message
            });
